# ユースケース設計書: ドキュメント同期システム（Cursor拡張機能）

## 概要

本ドキュメントは、複数人でMarkdownなどのテキストドキュメントを管理・同期するCursor拡張機能のユースケースを定義する。

### 関連ドキュメント
- ユーザーストーリー1

### 更新履歴
| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2024-01-15 | 1.0 | 初版作成 |

---

## ユースケース一覧

| ID | ユースケース名 | Phase | 優先度 |
|----|---------------|-------|--------|
| UC-01 | Git管理フォルダの自動検出と同期開始 | MVP | 必須 |
| UC-02 | 編集内容の自動反映 | MVP | 必須 |
| UC-03 | 他メンバーの変更の自動取得 | MVP | 必須 |
| UC-04 | 手動同期トリガー | MVP | 必須 |
| UC-05 | コンフリクト状態での保存 | MVP | 必須 |
| UC-06 | コンフリクトファイル一覧表示 | Phase 2 | 高 |
| UC-07 | コンフリクト詳細の確認 | Phase 2 | 高 |
| UC-08 | 変更履歴の確認 | Phase 2 | 中 |
| UC-09 | コンフリクト解消プロンプトのコピー | Phase 3 | 中 |
| UC-10 | AIによるコンフリクト自動解消 | Phase 3 | 中 |

---

## MVP（Phase 1）

### UC-01: Git管理フォルダの自動検出と同期開始

#### 概要
| 項目 | 内容 |
|------|------|
| ユースケースID | UC-01 |
| ユースケース名 | Git管理フォルダの自動検出と同期開始 |
| アクター | ユーザー（企画担当者/テクニカルライター/エンジニア） |
| 関連ストーリー | ユーザーストーリー #1 |

#### 事前条件
- Cursor IDEがインストールされている
- 本拡張機能がCursorにインストールされている
- ユーザーがGit管理されたフォルダ（`.git`ディレクトリが存在）を持っている
- リモートリポジトリが設定されている

#### 事後条件
- 自動同期機能が有効化される
- 定期的なプル・プッシュのスケジューリングが開始される

#### 基本フロー

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | Cursorでフォルダを開く | - |
| 2 | - | ワークスペース内に`.git`ディレクトリが存在するか検出する |
| 3 | - | jujutsuの初期化状態を確認する（未初期化の場合は初期化） |
| 4 | - | リモートリポジトリの接続状態を確認する |
| 5 | - | ステータスバーに「同期: 有効」を表示する |
| 6 | - | 自動プル・プッシュのタイマーを開始する |
| 7 | ユーザーは通常の編集作業を開始する | - |

#### 代替フロー

**2a. `.git`ディレクトリが存在しない場合**
- システムは同期機能を無効のままにする
- ステータスバーに「同期: 対象外」を表示する
- ユースケース終了

**4a. リモートリポジトリが設定されていない場合**
- システムは通知で「リモートリポジトリが設定されていません」と表示する
- ローカルのみの変更追跡は有効にする
- プッシュ機能は無効化する

**4b. リモートリポジトリに接続できない場合**
- システムはステータスバーに「同期: オフライン」を表示する
- ローカルでの変更追跡は継続する
- 接続回復時に自動で同期を再開する

#### 補足・備考
- jujutsuが未インストールの場合の初回セットアップフローは別ユースケースで定義
- 複数ワークスペースを開いた場合は、各ワークスペースで独立して検出・同期を行う

---

### UC-02: 編集内容の自動反映

#### 概要
| 項目 | 内容 |
|------|------|
| ユースケースID | UC-02 |
| ユースケース名 | 編集内容の自動反映 |
| アクター | ユーザー（企画担当者/テクニカルライター/エンジニア） |
| 関連ストーリー | ユーザーストーリー #2 |

#### 事前条件
- UC-01が完了し、同期が有効化されている
- ユーザーがワークスペース内のファイルを編集している

#### 事後条件
- ユーザーの変更がリモートリポジトリに反映される
- 他のメンバーが変更を取得可能な状態になる

#### 基本フロー

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | ファイルを編集する | - |
| 2 | ファイルを保存する（Ctrl+S / Cmd+S） | - |
| 3 | - | 変更を検知し、内部キューに追加する |
| 4 | - | ランダム間隔（30秒〜90秒）のタイマーを開始する |
| 5 | - | タイマー経過後、jujutsuで変更をコミットする |
| 6 | - | 自動生成されたコミットメッセージを付与する（例: "Auto-sync: 2024-01-15 14:32"） |
| 7 | - | リモートリポジトリにプッシュする |
| 8 | - | ステータスバーに「同期完了」を一時表示する |

#### 代替フロー

**4a. タイマー待機中に追加の変更があった場合**
- システムはタイマーをリセットせず、待機中の変更をまとめる
- ステップ5で全ての変更を一括コミットする

**7a. プッシュに失敗した場合（ネットワークエラー）**
- システムはステータスバーに「同期: 再試行待ち」を表示する
- 30秒後に自動リトライする（最大3回）
- 3回失敗後、通知で「同期に失敗しました。ネットワークを確認してください」と表示する
- ローカルコミットは保持され、次回成功時にプッシュされる

**7b. プッシュに失敗した場合（リモートに新しい変更あり）**
- システムはUC-03（他メンバーの変更の自動取得）を実行する
- 取得完了後、再度プッシュを試みる

**7c. コンフリクトが発生した場合**
- jujutsuがコンフリクトマーカー付きで状態を保持する
- システムはコンフリクト状態のままコミット・プッシュする
- UC-06（コンフリクトファイル一覧）に通知を送る
- ステータスバーに「同期完了（コンフリクトあり）」を表示する

#### 補足・備考
- ランダム間隔は同時編集時のプッシュ競合を軽減するため
- コミットメッセージの形式は設定でカスタマイズ可能（将来拡張）
- `.gitignore`に含まれるファイルの変更は無視する

---

### UC-03: 他メンバーの変更の自動取得

#### 概要
| 項目 | 内容 |
|------|------|
| ユースケースID | UC-03 |
| ユースケース名 | 他メンバーの変更の自動取得 |
| アクター | システム（自動実行）、ユーザー（結果確認） |
| 関連ストーリー | ユーザーストーリー #3 |

#### 事前条件
- UC-01が完了し、同期が有効化されている
- リモートリポジトリに接続可能な状態

#### 事後条件
- ローカルファイルがリモートの最新状態に更新される
- コンフリクトがある場合はマーカー付きで保持される

#### 基本フロー

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | - | 定期タイマー（30秒〜90秒のランダム間隔）が発火する |
| 2 | - | リモートリポジトリから最新の変更を取得する（fetch） |
| 3 | - | ローカルとリモートの差分を検出する |
| 4 | - | jujutsuで変更をマージする |
| 5 | - | ワークスペース内のファイルを更新する |
| 6 | - | ステータスバーに「最新の状態」を表示する |
| 7 | ユーザーは更新されたファイルで作業を継続する | - |

#### 代替フロー

**2a. ネットワーク接続がない場合**
- システムはステータスバーに「同期: オフライン」を表示する
- 次回タイマー発火時に再試行する
- ユースケース終了

**3a. リモートに新しい変更がない場合**
- システムは何もせずユースケース終了

**4a. マージ時にコンフリクトが発生した場合**
- jujutsuがコンフリクトマーカー付きでファイルを更新する
- システムはUC-06に通知を送り、コンフリクト一覧を更新する
- ステータスバーに「同期完了（コンフリクトあり）」を表示する
- 通知で「◯件のコンフリクトがあります」と表示する

**5a. ユーザーが同一ファイルを編集中の場合**
- システムはエディタの内容を強制更新しない
- ファイルシステム上は更新し、エディタに「ディスク上で変更されました」の通知を出す

#### 補足・備考
- 編集中ファイルの扱いはCursorのデフォルト動作に従う
- 大量の変更がある場合も、バックグラウンドで処理しUIをブロックしない

---

### UC-04: 手動同期トリガー

#### 概要
| 項目 | 内容 |
|------|------|
| ユースケースID | UC-04 |
| ユースケース名 | 手動同期トリガー |
| アクター | ユーザー（企画担当者/テクニカルライター/エンジニア） |
| 関連ストーリー | ユーザーストーリー #4 |

#### 事前条件
- UC-01が完了し、同期が有効化されている

#### 事後条件
- ローカルの変更がリモートにプッシュされる
- リモートの変更がローカルに取得される

#### 基本フロー

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | サイドバーの「今すぐ同期」ボタンをクリック、またはコマンドパレットから「DocSync: 今すぐ同期」を実行する | - |
| 2 | - | 自動同期タイマーを一時停止する |
| 3 | - | 未保存の変更があれば全ファイルを保存する |
| 4 | - | ローカルの変更をコミットする |
| 5 | - | リモートから最新の変更を取得する（pull） |
| 6 | - | ローカルの変更をプッシュする |
| 7 | - | ステータスバーに「同期完了」を表示する |
| 8 | - | 自動同期タイマーを再開する |
| 9 | ユーザーは作業を継続する | - |

#### 代替フロー

**1a. キーボードショートカットで実行する場合**
- ユーザーは設定済みのショートカット（デフォルト: Ctrl+Shift+S / Cmd+Shift+S）を押す
- ステップ2に進む

**5a. コンフリクトが発生した場合**
- UC-03の代替フロー4aと同様の処理を行う
- 通知で「同期完了しましたが、◯件のコンフリクトがあります」と表示する

**6a. プッシュに失敗した場合**
- 通知で「同期に失敗しました: [エラー詳細]」を表示する
- ローカルコミットは保持される

#### 補足・備考
- 手動同期中はステータスバーに「同期中...」とスピナーを表示する
- 同期完了後、3秒で通常表示に戻る

---

### UC-05: コンフリクト状態での保存

#### 概要
| 項目 | 内容 |
|------|------|
| ユースケースID | UC-05 |
| ユースケース名 | コンフリクト状態での保存 |
| アクター | ユーザー（企画担当者/テクニカルライター/エンジニア） |
| 関連ストーリー | ユーザーストーリー #5 |

#### 事前条件
- ファイルにコンフリクトマーカーが含まれている
- 同期が有効化されている

#### 事後条件
- コンフリクトマーカー付きの状態でリモートに保存される
- 他のメンバーがコンフリクト状態を確認できる

#### 基本フロー

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | コンフリクトマーカーが含まれたファイルを編集する（または編集せずそのまま） | - |
| 2 | ファイルを保存する | - |
| 3 | - | コンフリクトマーカーの存在を検知する |
| 4 | - | jujutsuでコンフリクト状態のままコミットする |
| 5 | - | リモートリポジトリにプッシュする |
| 6 | - | ステータスバーに「同期完了（コンフリクト未解消）」を表示する |
| 7 | ユーザーは他の作業を継続できる | - |

#### 代替フロー

**3a. ユーザーがコンフリクトを解消してから保存した場合**
- システムはコンフリクトマーカーがないことを検知する
- 通常のコミット・プッシュを行う（UC-02と同様）
- UC-06のコンフリクト一覧から該当ファイルを削除する

#### 補足・備考
- jujutsuの特徴として、コンフリクト状態でもコミット可能
- コンフリクトマーカーの形式: `<<<<<<<`, `=======`, `>>>>>>>`
- コンフリクト状態のファイルはUC-06で一覧表示される

---

## Phase 2 - コンフリクト可視化

### UC-06: コンフリクトファイル一覧表示

#### 概要
| 項目 | 内容 |
|------|------|
| ユースケースID | UC-06 |
| ユースケース名 | コンフリクトファイル一覧表示 |
| アクター | ユーザー（企画担当者/テクニカルライター/エンジニア） |
| 関連ストーリー | ユーザーストーリー #6 |

#### 事前条件
- UC-01が完了し、同期が有効化されている
- 拡張機能のサイドバーが表示可能な状態

#### 事後条件
- ユーザーがコンフリクト状態のファイルを把握できる

#### 基本フロー

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | サイドバーの拡張機能アイコンをクリックする | - |
| 2 | - | jujutsuからコンフリクト状態のファイル一覧を取得する |
| 3 | - | サイドバーに「コンフリクト中」セクションを表示する |
| 4 | - | コンフリクトファイルをリスト表示する（ファイル名、パス） |
| 5 | - | セクションヘッダーにファイル数バッジを表示する（例: 「コンフリクト中 (3)」） |
| 6 | ユーザーはリストを確認し、対応が必要なファイルを把握する | - |

#### 代替フロー

**2a. コンフリクトが存在しない場合**
- システムは「コンフリクト中」セクションに「コンフリクトはありません」と表示する
- バッジは表示しない

**6a. ファイルをクリックした場合**
- システムは該当ファイルをエディタで開く
- コンフリクトマーカーの最初の箇所にカーソルを移動する

#### 補足・備考
- 一覧は同期のたびに自動更新される
- 各ファイルの横にはUC-07、UC-09、UC-10へのアクションボタンを配置

---

### UC-07: コンフリクト詳細の確認

#### 概要
| 項目 | 内容 |
|------|------|
| ユースケースID | UC-07 |
| ユースケース名 | コンフリクト詳細の確認 |
| アクター | ユーザー（企画担当者/テクニカルライター/エンジニア） |
| 関連ストーリー | ユーザーストーリー #7 |

#### 事前条件
- UC-06でコンフリクトファイル一覧が表示されている
- 対象ファイルにコンフリクトが存在する

#### 事後条件
- ユーザーがコンフリクトの原因と関係者を理解できる

#### 基本フロー

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | コンフリクトファイルの「詳細」ボタンをクリック、またはファイルをホバーする | - |
| 2 | - | jujutsuから該当ファイルのコンフリクト情報を取得する |
| 3 | - | 衝突した両方の変更のメタデータを取得する（作者、日時、コミットメッセージ） |
| 4 | - | ポップオーバーまたはパネルに詳細情報を表示する |
| 5 | ユーザーは詳細を確認し、対応方針を判断する | - |

#### 表示内容

```
コンフリクト詳細
─────────────────
ファイル: docs/setup.md

◆ 自分の変更
  作者: 山田太郎
  日時: 2024-01-15 14:30
  変更行: 45-52

◆ 衝突した変更
  作者: 佐藤花子
  日時: 2024-01-15 14:25
  変更行: 48-55

コンフリクト箇所: 3件
```

#### 代替フロー

**3a. 作者情報が取得できない場合**
- システムは「不明なユーザー」と表示する

**4a. パネル表示を選択した場合**
- ユーザーが「パネルで開く」をクリックする
- システムは専用パネルに詳細情報と差分ビューを表示する

#### 補足・備考
- 複数箇所にコンフリクトがある場合は、箇所ごとの情報を表示
- 差分ビューはCursorの差分表示機能と連携（将来拡張）

---

### UC-08: 変更履歴の確認

#### 概要
| 項目 | 内容 |
|------|------|
| ユースケースID | UC-08 |
| ユースケース名 | 変更履歴の確認 |
| アクター | ユーザー（企画担当者/テクニカルライター/エンジニア） |
| 関連ストーリー | ユーザーストーリー #8 |

#### 事前条件
- UC-01が完了し、同期が有効化されている
- リポジトリにコミット履歴が存在する

#### 事後条件
- ユーザーがドキュメントの変更経緯を把握できる

#### 基本フロー

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | サイドバーの「履歴」タブをクリック、またはコマンドパレットから「DocSync: 履歴を表示」を実行する | - |
| 2 | - | jujutsuからコミット履歴を取得する（最新20件） |
| 3 | - | サイドバーまたはパネルに履歴一覧を表示する |
| 4 | ユーザーは履歴を確認する | - |

#### 表示内容

```
変更履歴
─────────────────
● 2024-01-15 14:32 - 山田太郎
  Auto-sync: docs/setup.md, docs/api.md
  
● 2024-01-15 14:25 - 佐藤花子
  Auto-sync: docs/setup.md
  
● 2024-01-15 13:50 - 鈴木一郎
  Auto-sync: README.md

[さらに読み込む]
```

#### 代替フロー

**1a. 特定ファイルの履歴を確認する場合**
- ユーザーはエディタでファイルを開き、右クリック→「このファイルの履歴」を選択
- システムは該当ファイルに関するコミットのみをフィルタして表示

**4a. 履歴項目をクリックした場合**
- システムは該当コミットの詳細（変更ファイル一覧、差分）を表示する

**4b. 「さらに読み込む」をクリックした場合**
- システムは追加で20件の履歴を取得して表示に追加する

#### 補足・備考
- 自動生成されたコミットメッセージは読みやすく整形して表示
- 日時はユーザーのローカルタイムゾーンで表示

---

## Phase 3 - AI解消サポート

### UC-09: コンフリクト解消プロンプトのコピー

#### 概要
| 項目 | 内容 |
|------|------|
| ユースケースID | UC-09 |
| ユースケース名 | コンフリクト解消プロンプトのコピー |
| アクター | ユーザー（企画担当者/テクニカルライター/エンジニア） |
| 関連ストーリー | ユーザーストーリー #9 |

#### 事前条件
- UC-06でコンフリクトファイル一覧が表示されている
- 対象ファイルにコンフリクトが存在する

#### 事後条件
- AIへの指示プロンプトがクリップボードにコピーされる

#### 基本フロー

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | コンフリクトファイルの「プロンプトをコピー」ボタンをクリックする | - |
| 2 | - | jujutsuからコンフリクトの詳細情報を取得する |
| 3 | - | コンフリクト箇所（行番号）を特定する |
| 4 | - | プロンプトテンプレートに情報を埋め込む |
| 5 | - | 生成したプロンプトをクリップボードにコピーする |
| 6 | - | 通知で「プロンプトをコピーしました」と表示する |
| 7 | ユーザーはCursorのAIチャットにプロンプトを貼り付けて実行する | - |

#### 生成されるプロンプト例

```
以下のファイルにコンフリクトがあります。解消してください。

ファイル: docs/setup.md
コンフリクト箇所: 45行目〜58行目

コンフリクトの状況:
- 山田太郎さん（2024-01-15 14:30）の変更: インストール手順を更新
- 佐藤花子さん（2024-01-15 14:25）の変更: 前提条件を追加

両者の意図を汲んで、適切な解消案を提示してください。
変更内容が両立できる場合は両方を活かし、
矛盾する場合は理由を説明した上で推奨案を示してください。
```

#### 代替フロー

**2a. 複数箇所にコンフリクトがある場合**
- システムは全てのコンフリクト箇所をプロンプトに含める

#### 補足・備考
- プロンプトテンプレートは設定でカスタマイズ可能（将来拡張）
- ファイルの内容自体はプロンプトに含めない（Cursorが自動で参照するため）

---

### UC-10: AIによるコンフリクト自動解消

#### 概要
| 項目 | 内容 |
|------|------|
| ユースケースID | UC-10 |
| ユースケース名 | AIによるコンフリクト自動解消 |
| アクター | ユーザー（企画担当者/テクニカルライター/エンジニア） |
| 関連ストーリー | ユーザーストーリー #10 |

#### 事前条件
- UC-06でコンフリクトファイル一覧が表示されている
- 対象ファイルにコンフリクトが存在する
- CursorのAI機能が利用可能な状態

#### 事後条件
- コンフリクトが解消された状態でファイルが更新される
- ユーザーが結果を確認・承認する

#### 基本フロー

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | コンフリクトファイルの「AIで解消」ボタンをクリックする | - |
| 2 | - | 確認ダイアログを表示する「AIでコンフリクトを解消しますか？」 |
| 3 | ユーザーが「実行」をクリックする | - |
| 4 | - | jujutsuからコンフリクト情報を取得する |
| 5 | - | UC-09と同様のプロンプトを生成する |
| 6 | - | CursorのAI API（またはComposer機能）を呼び出す |
| 7 | - | AIが生成した解消案をエディタに適用する（差分表示モード） |
| 8 | ユーザーは解消案を確認する | - |
| 9 | ユーザーが「承認」をクリックする | - |
| 10 | - | 解消案をファイルに確定保存する |
| 11 | - | UC-02の自動反映フローが開始される |
| 12 | - | UC-06のコンフリクト一覧から該当ファイルを削除する |

#### 代替フロー

**3a. ユーザーがキャンセルした場合**
- ユースケース終了、コンフリクトは維持される

**6a. AI API呼び出しに失敗した場合**
- 通知で「AI解消に失敗しました。手動で解消するか、再試行してください」と表示する
- ユースケース終了

**8a. 解消案が不適切と判断した場合**
- ユーザーは「却下」をクリックする
- システムは変更を破棄し、元のコンフリクト状態に戻す
- 通知で「解消をキャンセルしました」と表示する

**8b. 解消案を修正したい場合**
- ユーザーは差分表示モードのまま手動で編集する
- 編集完了後「承認」をクリックする
- ステップ10に進む

**9a. 一部のコンフリクトのみ承認する場合**
- 複数コンフリクトがある場合、各箇所ごとに「承認/却下」を選択できる
- 却下された箇所はコンフリクトマーカーが残る

#### 補足・備考
- AI解消中はステータスバーに「AI解消中...」と表示
- 解消結果のコミットメッセージには「AI-resolved conflict」を含める
- 大きなファイルや複雑なコンフリクトは処理に時間がかかる場合がある

---

## 付録

### ユースケース間の依存関係

```
UC-01 (自動検出)
  ├── UC-02 (自動反映) ──────┐
  ├── UC-03 (自動取得) ──────┼── UC-05 (コンフリクト保存)
  ├── UC-04 (手動同期) ──────┘         │
  └── UC-08 (履歴確認)                 │
                                       ▼
                              UC-06 (一覧表示)
                                ├── UC-07 (詳細確認)
                                ├── UC-09 (プロンプトコピー)
                                └── UC-10 (AI解消)
```

### 用語集

| 用語 | 説明 |
|------|------|
| jujutsu | Gitリポジトリ上で動作する次世代バージョン管理システム。コンフリクト状態でもコミット可能 |
| コンフリクトマーカー | `<<<<<<<`, `=======`, `>>>>>>>` で囲まれた、衝突箇所を示すテキスト |
| 同期 | ローカルの変更をリモートに反映し、リモートの変更をローカルに取得する一連の操作 |
| DocSync | 本拡張機能の仮称 |